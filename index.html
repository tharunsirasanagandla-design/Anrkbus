<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bus Live Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet Map CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <style>
    body { margin:0; font-family:Arial; background:#f2f2f2; }
    header { background:#007bff; color:#fff; padding:15px; text-align:center; font-size:22px; }
    #map { height: 70vh; width:100%; margin-top:10px; }
    .box { padding:10px; text-align:center; }
    input {
      padding:10px; width:70%; border-radius:6px; border:1px solid #aaa; margin-bottom:10px;
    }
    button {
      padding:10px 20px; background:#007bff; border:none; color:white;
      border-radius:6px; font-size:16px; cursor:pointer;
    }
  </style>
</head>
<body>

<header>üöç Bus Live Tracking</header>

<div class="box">
  <h3>Driver Code / Student Code</h3>
  <input id="codeBox" placeholder="Enter Code (Example: 5999)">
  <br>
  <button onclick="submitCode()">Submit Code</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ---------------- MAP SETUP ---------------- */
const map = L.map("map").setView([17.2807,79.4851], 14); // default city

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom:19
}).addTo(map);

/* ---------------- GLOBALS ---------------- */
let driverMode = false;
let matches = false;
let DRIVER_CODE = "5999";  // you can change later
let driverMarker = null;
let studentMarker = null;

/* ---------------- ASK FOR LOCATION ---------------- */
function askUserLocation() {
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    if (driverMode) {
      updateDriverLocation(lat, lng);
    } else {
      if (studentMarker) studentMarker.remove();
      studentMarker = L.marker([lat,lng]).addTo(map).bindPopup("You");
      map.setView([lat,lng], 16);
    }

  }, err=>{
    alert("Please allow location access!");
  });
}

/* ---------------- SUBMIT CODE LOGIC ---------------- */
function submitCode(){
  const code = document.getElementById("codeBox").value;

  if (code === DRIVER_CODE) {
    driverMode = true;
    matches = true;
    alert("Driver Mode Activated.\nYour location will be shared.");
    askUserLocation();
    setInterval(askUserLocation, 5000);  // update every 5 sec
  }
  else {
    driverMode = false;
    if (code === DRIVER_CODE) {
      matches = true;
      alert("Student Mode Activated.\nDriver location will be shown.");
      simulateDriverMovement();  // TEMP until Firebase added
    } else {
      alert("Invalid Code!");
    }
  }
}

/* ---------------- TEMP DRIVER SIMULATION ---------------- */
/* until Firebase config arrives */
function simulateDriverMovement(){
  if (!matches) return;

  let lat = 17.2807;
  let lng = 79.4851;

  driverMarker = L.marker([lat,lng]).addTo(map);

  setInterval(()=>{
    lat += (Math.random()-0.5)*0.001;
    lng += (Math.random()-0.5)*0.001;
    driverMarker.setLatLng([lat,lng]);
  }, 3000);
}

/* ---------------- DRIVER GPS UPLOAD (Firebase later) ---------------- */
function updateDriverLocation(lat,lng){
  if (!driverMarker) {
    driverMarker = L.marker([lat,lng]).addTo(map).bindPopup("Driver");
  } else {
    driverMarker.setLatLng([lat,lng]);
  }
  map.setView([lat,lng],16);

  // Firebase update will be here:
  // firebase.database().ref("bus/5999").set({lat:lat, lng:lng});
}

</script>

</body>
</html>
